require "json"
require "colorize"
require "./vulnerability_scanner"

module Shards
  class VulnerabilityReport
    getter results : Array(PackageScanResult)
    getter ignore_rules : Array(IgnoreRule)
    getter min_severity : Severity
    getter fail_above : Severity?

    @ignored_count : Int32 = 0
    @filtered_count : Int32 = 0

    def initialize(@results, @ignore_rules = [] of IgnoreRule,
                   @min_severity = Severity::Unknown,
                   @fail_above : Severity? = nil)
    end

    # Returns filtered results (after applying ignore rules and severity filter).
    def filtered_results : Array(PackageScanResult)
      @ignored_count = 0
      @filtered_count = 0

      @results.map do |result|
        filtered_vulns = result.vulnerabilities.select do |vuln|
          active_ignore = @ignore_rules.find { |rule| rule.id == vuln.id && rule.active? }
          if active_ignore
            @ignored_count += 1
            next false
          end

          # Check aliases too
          alias_ignored = vuln.aliases.any? { |a| @ignore_rules.any? { |rule| rule.id == a && rule.active? } }
          if alias_ignored
            @ignored_count += 1
            next false
          end

          if vuln.severity.at_or_above?(@min_severity)
            true
          else
            @filtered_count += 1
            false
          end
        end

        PackageScanResult.new(result.package, result.purl, filtered_vulns)
      end
    end

    # Returns appropriate exit code.
    # 0 = no vulnerabilities above threshold
    # 1 = vulnerabilities found above threshold
    def exit_code : Int32
      threshold = @fail_above || Severity::Low
      filtered = filtered_results
      has_vulns = filtered.any? { |r| r.vulnerabilities.any? { |v| v.severity.at_or_above?(threshold) } }
      has_vulns ? 1 : 0
    end

    # Total vulnerability count after filtering.
    def vulnerability_count : Int32
      filtered_results.sum(&.vulnerabilities.size)
    end

    # --- Terminal Output ---

    def to_terminal(io : IO = STDOUT)
      filtered = filtered_results
      vulnerable_packages = filtered.select(&.vulnerable?)
      total_vulns = filtered.sum(&.vulnerabilities.size)
      total_packages = @results.size

      if vulnerable_packages.empty?
        io.puts "No known vulnerabilities found in #{total_packages} package(s).".colorize(:green)
        print_stats(io)
        return
      end

      io.puts "Found #{total_vulns} vulnerability(ies) in #{vulnerable_packages.size} package(s):".colorize(:red).bold
      io.puts

      vulnerable_packages.each do |result|
        io.puts "  #{result.package.name} (#{result.package.version})".colorize(:yellow).bold
        if purl = result.purl
          io.puts "    purl: #{purl}".colorize(:light_gray)
        end

        result.vulnerabilities.sort_by { |v| -v.severity.value }.each do |vuln|
          severity_str = severity_badge(vuln.severity)
          io.puts "    #{severity_str} #{vuln.id}"
          io.puts "      #{vuln.summary}" unless vuln.summary.empty?

          unless vuln.aliases.empty?
            io.puts "      Aliases: #{vuln.aliases.join(", ")}".colorize(:light_gray)
          end

          if ref = vuln.references.first?
            io.puts "      More info: #{ref}".colorize(:light_gray)
          end
          io.puts
        end
      end

      print_stats(io)
    end

    private def severity_badge(severity : Severity) : String
      case severity
      when .critical? then "[CRITICAL]".colorize(:red).bold.to_s
      when .high?     then "[HIGH]".colorize(:red).to_s
      when .medium?   then "[MEDIUM]".colorize(:yellow).to_s
      when .low?      then "[LOW]".colorize(:light_gray).to_s
      else                 "[UNKNOWN]".colorize(:dark_gray).to_s
      end
    end

    private def print_stats(io : IO)
      parts = [] of String
      parts << "#{@ignored_count} ignored" if @ignored_count > 0
      parts << "#{@filtered_count} below severity threshold" if @filtered_count > 0
      unless parts.empty?
        io.puts "(#{parts.join(", ")})".colorize(:dark_gray)
      end
    end

    # --- JSON Output ---

    def to_json(io : IO)
      filtered = filtered_results

      JSON.build(io, indent: 2) do |json|
        json.object do
          json.field "schema_version", "1.0.0"
          json.field "tool", "shards-alpha"
          json.field "tool_version", VERSION
          json.field "timestamp", Time.utc.to_rfc3339

          json.field "summary" do
            json.object do
              json.field "total_packages", @results.size
              json.field "vulnerable_packages", filtered.count(&.vulnerable?)
              json.field "total_vulnerabilities", filtered.sum(&.vulnerabilities.size)
              json.field "ignored", @ignored_count
              json.field "filtered_by_severity", @filtered_count
            end
          end

          json.field "packages" do
            json.array do
              filtered.select(&.vulnerable?).each do |result|
                json.object do
                  json.field "name", result.package.name
                  json.field "version", result.package.version.to_s
                  json.field "purl", result.purl

                  json.field "vulnerabilities" do
                    json.array do
                      result.vulnerabilities.each do |vuln|
                        json.object do
                          json.field "id", vuln.id
                          json.field "summary", vuln.summary
                          json.field "severity", vuln.severity.to_s.downcase
                          json.field "cvss_score", vuln.cvss_score
                          json.field "aliases" do
                            json.array { vuln.aliases.each { |a| json.string a } }
                          end
                          json.field "references" do
                            json.array { vuln.references.each { |r| json.string r } }
                          end
                          json.field "published", vuln.published.try(&.to_rfc3339)
                          json.field "modified", vuln.modified.try(&.to_rfc3339)
                        end
                      end
                    end
                  end
                end
              end
            end
          end
        end
      end
    end

    # --- SARIF Output ---
    # SARIF 2.1.0 format for integration with GitHub Advanced Security, Azure DevOps, etc.

    def to_sarif(io : IO)
      filtered = filtered_results

      JSON.build(io, indent: 2) do |json|
        json.object do
          json.field "$schema", "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/main/sarif-2.1/schema/sarif-schema-2.1.0.json"
          json.field "version", "2.1.0"

          json.field "runs" do
            json.array do
              json.object do
                json.field "tool" do
                  json.object do
                    json.field "driver" do
                      json.object do
                        json.field "name", "shards-alpha audit"
                        json.field "version", VERSION
                        json.field "informationUri", "https://github.com/crimson-knight/shards"

                        # Rules: one per unique vulnerability ID
                        json.field "rules" do
                          json.array do
                            unique_vulns = filtered.flat_map(&.vulnerabilities).uniq(&.id)
                            unique_vulns.each do |vuln|
                              json.object do
                                json.field "id", vuln.id
                                json.field "shortDescription" do
                                  json.object do
                                    json.field "text", vuln.summary.empty? ? vuln.id : vuln.summary
                                  end
                                end
                                json.field "fullDescription" do
                                  json.object do
                                    json.field "text", vuln.details.empty? ? vuln.summary : vuln.details
                                  end
                                end
                                json.field "defaultConfiguration" do
                                  json.object do
                                    json.field "level", sarif_level(vuln.severity)
                                  end
                                end
                                unless vuln.references.empty?
                                  json.field "helpUri", vuln.references.first
                                end
                              end
                            end
                          end
                        end
                      end
                    end
                  end
                end

                # Results
                json.field "results" do
                  json.array do
                    filtered.select(&.vulnerable?).each do |result|
                      result.vulnerabilities.each do |vuln|
                        json.object do
                          json.field "ruleId", vuln.id
                          json.field "level", sarif_level(vuln.severity)
                          json.field "message" do
                            json.object do
                              json.field "text", "#{result.package.name}@#{result.package.version} is affected by #{vuln.id}: #{vuln.summary}"
                            end
                          end
                          json.field "locations" do
                            json.array do
                              json.object do
                                json.field "physicalLocation" do
                                  json.object do
                                    json.field "artifactLocation" do
                                      json.object do
                                        json.field "uri", "shard.lock"
                                      end
                                    end
                                  end
                                end
                              end
                            end
                          end
                        end
                      end
                    end
                  end
                end
              end
            end
          end
        end
      end
    end

    private def sarif_level(severity : Severity) : String
      case severity
      when .critical?, .high? then "error"
      when .medium?           then "warning"
      when .low?              then "note"
      else                         "none"
      end
    end
  end
end
